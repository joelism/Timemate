<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TimeMate JW — Light v4</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="tmassets/icon-180x180.png">
  <style>
    :root{--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--card:#f8fafc;--primary:#0ea5e9;--danger:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,Segoe UI,Roboto,Arial;color:var(--fg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:10px 12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:28px;height:28px;border-radius:6px}
    h1{font-size:20px;margin:0}.muted{color:var(--muted)}.small{font-size:12px}
    nav{display:grid;grid-auto-flow:column;gap:8px;margin-top:8px}
    nav button{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px}
    nav .active{background:#eef2f7}
    main{padding:16px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:grid;gap:6px}
    .title{font-weight:600}
    .row{display:flex;gap:10px}.half{flex:1}
    label{display:grid;gap:6px;margin-bottom:12px}
    input,select,textarea,button{border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:16px;background:#fff}
    button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    button.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .list{display:grid;gap:10px}
    .item{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
    .meta{color:var(--muted);font-size:12px}
    footer{padding:20px 16px 32px;text-align:center;color:var(--muted)}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .err{position:fixed;left:12px;right:12px;bottom:12px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:10px 12px;border-radius:10px;font-size:12px;z-index:9999;display:none}
  </style>
  <script>
    // Hard reset any old Service Workers & caches right away
    (async function(){
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
        if(window.caches){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
      }catch(e){ /* ignore */ }
    })();
  </script>
</head>
<body>
<header>
  <div class="brand">
    <img src="tmassets/icon-180x180.png" alt="">
    <h1>TimeMate <span class="muted">JW</span> <span class="small muted">(Light v4)</span></h1>
  </div>
  <nav>
    <button data-route="overview" class="tab active">Übersicht</button>
    <button data-route="new" class="tab">Neuer Termin</button>
    <button data-route="list" class="tab">Liste</button>
    <button data-route="archive" class="tab">Archiv</button>
    <button data-route="settings" class="tab">Einstellungen</button>
  </nav>
</header>

<main id="view"></main>
<div id="err" class="err"></div>
<footer><small>© TimeMate JW</small></footer>

<script>
(function(){
  function show(msg){ var el=document.getElementById('err'); el.style.display='block'; el.textContent='Fehler: '+msg; }
  window.addEventListener('error', function(e){ show(e.message || e.error || e); });
  window.addEventListener('unhandledrejection', function(e){ show((e.reason && (e.reason.message||e.reason)) || e); });
})();

const state = { items: JSON.parse(localStorage.getItem('tmjw_light')||'[]') };
const CATS = ["Spitex Heitersberg","Psychologin / Therapie","Töpferhaus","Administrativ","Geschäftlich","Privat"];
function save(){ localStorage.setItem('tmjw_light', JSON.stringify(state.items)); }
function byId(id){ return document.getElementById(id); }
function fmt(iso){ var d=new Date(iso); return d.toLocaleString('de-CH',{dateStyle:'medium',timeStyle:'short'}); }
function route(name){
  document.querySelectorAll('.tab').forEach(function(b){ b.classList.toggle('active', b.dataset.route===name); });
  if(name==='overview') renderOverview();
  if(name==='new') renderNew();
  if(name==='list') renderList();
  if(name==='archive') renderArchive();
  if(name==='settings') renderSettings();
  history.replaceState(null, '', '#'+name);
}
function autoUpdate(){
  var now=Date.now(); var changed=false;
  state.items.forEach(function(a){
    var due=new Date(a.datetime).getTime();
    if(a.status!=='archived' && now>=due && a.status!=='done'){ a.status='done'; a.completedCount=(a.completedCount||0)+1; changed=true; }
    if(a.status!=='archived' && now-due>72*60*60*1000 && (a.completedCount||0)>=1){ a.status='archived'; changed=true; }
  });
  if(changed) save();
}
function el(tag, attrs, text){
  var n=document.createElement(tag); attrs=attrs||{};
  Object.keys(attrs).forEach(function(k){ n.setAttribute(k, attrs[k]); });
  if(text!==undefined) n.textContent=text;
  return n;
}

function renderOverview(){
  try{
    autoUpdate();
    var v=byId('view'); v.innerHTML='';
    var grid=el('section',{class:'grid'});
    var upcoming=state.items.filter(function(x){ return x.status!=='archived' && new Date(x.datetime)>new Date(); })
                            .sort(function(a,b){ return new Date(a.datetime)-new Date(b.datetime); });
    CATS.forEach(function(cat){
      var card=el('div',{class:'card'});
      card.append(el('div',{class:'title'},cat));
      var next=upcoming.find(function(x){ return x.category===cat; });
      if(next){
        card.append(el('div',{}, next.title||'(ohne Titel)'));
        var person = Array.isArray(next.person)? next.person.join(', ') : (next.person||'—');
        card.append(el('div',{}, fmt(next.datetime)+' · '+ person +' · '+ (next.location||'')));
        var btns = el('div',{class:'btnrow'});
        var done = el('button',{}, next.status==='done'?'✓ Erledigt':'☑️ Abhaken');
        done.addEventListener('click', function(){ next.status= next.status==='done'?'upcoming':'done'; if(next.status==='done'){next.completedCount=(next.completedCount||0)+1;} save(); renderOverview(); });
        btns.append(done);
        var toArch = el('button',{}, '↪ Archivieren');
        toArch.addEventListener('click', function(){ next.status='archived'; save(); renderOverview(); });
        btns.append(toArch);
        card.append(btns);
      } else {
        card.append(el('div',{}, '❗️ Kein Termin eingetragen'));
      }
      grid.append(card);
    });
    v.append(grid);
  }catch(e){ var elr=document.getElementById('err'); elr.textContent='Fehler in renderOverview: '+(e.message||e); elr.style.display='block'; }
}

function renderNew(){
  var v=byId('view'); v.innerHTML='';
  var sec=el('section',{class:'form'});
  sec.append(el('h2',{},'Neuen Termin anlegen'));
  var lTitle = el('label'); lTitle.append('Titel'); lTitle.append(el('input',{type:'text',id:'title',placeholder:'z.B. Kontrolle beim Arzt',required:'true'})); sec.append(lTitle);
  var lCat = el('label'); lCat.append('Kategorie');
  var sel = el('select',{id:'category',required:'true'});
  sel.append(el('option',{value:'',disabled:'true',selected:'true'},'Bitte wählen…'));
  CATS.forEach(function(c){ sel.append(el('option',{},c)); });
  lCat.append(sel); sec.append(lCat);
  var dyn = el('div',{id:'dyn'}); sec.append(dyn);
  var row = el('div',{class:'row'});
  var lDate = el('label',{class:'half'}); lDate.append('Datum'); lDate.append(el('input',{type:'date',id:'date',required:'true'})); row.append(lDate);
  var lTime = el('label',{class:'half'}); lTime.append('Uhrzeit'); lTime.append(el('input',{type:'time',id:'time',step:'300',required:'true'})); row.append(lTime);
  sec.append(row);
  var lNotes = el('label'); lNotes.append('Notizen'); lNotes.append(el('textarea',{id:'notes',rows:'4',placeholder:'Kurznotiz…'})); sec.append(lNotes);
  var saveBtn = el('button',{id:'save',class:'primary'},'Speichern'); sec.append(saveBtn);
  v.append(sec);

  sel.addEventListener('change', function(){ fillDyn(sel.value, dyn); });
  saveBtn.addEventListener('click', onSave);
}

function fillDyn(cat, d){
  d.innerHTML='';
  function mk(html){ var div=document.createElement('div'); div.innerHTML=html; return div.firstElementChild; }
  if(cat==='Spitex Heitersberg'){
    d.append(mk('<label>Termin mit<select id=\"person\"><option>F. Völki</option><option>A. Rudgers</option><option>Andere</option></select></label>'));
    d.append(mk('<label>Standort<select id=\"location\"><option>5000 Aarau</option><option>5200 Brugg</option><option>5442 Fislisbach</option><option>5507 Mellingen</option></select></label>'));
    d.append(mk('<input id=\"personOther\" placeholder=\"Andere (Name)\" style=\"display:none;\">'));
    d.querySelector('#person').addEventListener('change', function(){ d.querySelector('#personOther').style.display = d.querySelector('#person').value==='Andere' ? 'block':'none'; });
  } else if(cat==='Töpferhaus'){
    d.append(mk('<label>Termin mit<select id=\"person\"><option>Caroline Hanst</option><option>Jeanine Haygis</option><option>Sandra Schriber</option><option>Andere</option></select></label>'));
    d.append(mk('<label>Standort<select id=\"location\"><option>5000 Aarau - Bleichmattstr.</option><option>5000 Aarau - Bachstr. 95</option></select></label>'));
    d.append(mk('<input id=\"personOther\" placeholder=\"Andere (Name)\" style=\"display:none;\">'));
    d.querySelector('#person').addEventListener('change', function(){ d.querySelector('#personOther').style.display = d.querySelector('#person').value==='Andere' ? 'block':'none'; });
  } else if(cat==='Geschäftlich'){
    d.append(mk('<label>Termin mit (Mehrfachauswahl)<select id=\"personMulti\" multiple size=\"6\"><option>Beatriz Häsler</option><option>Helena Huser</option><option>Jasmin Widmer</option><option>Linda Flückiger</option><option>Mathias Tomaske</option><option>Svenja Studer</option></select></label>'));
    d.append(mk('<label>Standort<select id=\"location\"><option>5000 Aarau</option><option>3322 Schönbühl</option></select></label>'));
  } else if(cat==='Administrativ'){
    d.append(mk('<label>Person<input id=\"person\" placeholder=\"Name\"></label>'));
    d.append(mk('<label>Standort<input id=\"location\" list=\"locs\"></label>'));
  } else if(cat==='Privat'){
    d.append(mk('<label>Person<input id=\"person\" list=\"persons\"></label>'));
    d.append(mk('<label>Standort<input id=\"location\" list=\"locs\"></label>'));
  } else if(cat==='Psychologin / Therapie'){
    d.append(mk('<label>Termin mit<input id=\"person\" placeholder=\"Name\"></label>'));
    d.append(mk('<label>Standort<input id=\"location\" placeholder=\"Ort / Adresse\"></label>'));
  }
}

function onSave(){
  var title = byId('title').value.trim();
  var cat = byId('category').value;
  var date = byId('date').value;
  var time = byId('time').value;
  if(!title || !cat || !date || !time){ alert('Bitte Titel, Kategorie, Datum und Uhrzeit angeben.'); return; }
  var person = byId('personMulti') ? Array.from(byId('personMulti').selectedOptions).map(function(o){return o.value;})
              : (byId('personOther') && byId('personOther').style.display==='block' ? byId('personOther').value : (byId('person')?byId('person').value:''));
  var loc = byId('location') ? byId('location').value : '';
  var dt = new Date(date+'T'+time+':00');
  state.items.push({ id:String(Date.now()), title:title, category:cat, person:person, location:loc, datetime:dt.toISOString(), notes:byId('notes').value, status:'upcoming', completedCount:0, createdAt:new Date().toISOString() });
  save();
  alert('Termin gespeichert.');
  route('overview');
}

function renderList(){
  autoUpdate();
  var v=byId('view'); v.innerHTML = '<section><h2>Alle Termine</h2><div id=\"list\" class=\"list\"></div></section>';
  var list=byId('list');
  var all=state.items.slice().sort(function(a,b){ return new Date(a.datetime)-new Date(b.datetime); });
  if(!all.length){ list.innerHTML='<p class=\"muted small\">Keine Termine.</p>'; return; }
  all.forEach(function(a){
    var it=el('div',{class:'item'});
    var person = Array.isArray(a.person)?a.person.join(', '):(a.person||'—');
    it.append(el('div',{class:'title'}, a.title||'(ohne Titel)'));
    it.append(el('div',{}, a.category+' • '+fmt(a.datetime)+' '+(a.status==='done'?'✓':'')+' '+(a.status==='archived'?'(Archiv)':'')));
    it.append(el('div',{}, 'Person(en): '+person));
    it.append(el('div',{}, 'Standort: '+(a.location||'—')));
    it.append(el('div',{}, 'Notizen: '+(a.notes||'—')));
    var row=el('div',{class:'btnrow'});
    var btnDone=el('button',{}, a.status==='done'?'Als unerledigt markieren':'☑️ Abhaken');
    btnDone.addEventListener('click', function(){ a.status = a.status==='done'?'upcoming':'done'; if(a.status==='done'){a.completedCount=(a.completedCount||0)+1;} save(); renderList(); });
    row.append(btnDone);
    var btnArch=el('button',{}, '↪ Archivieren');
    btnArch.addEventListener('click', function(){ a.status='archived'; save(); renderList(); });
    row.append(btnArch);
    it.append(row);
    list.append(it);
  });
}

function renderArchive(){
  autoUpdate();
  var v=byId('view'); v.innerHTML = '<section><h2>Archiv</h2><div id=\"arch\" class=\"list\"></div></section>';
  var arch=byId('arch');
  var arr=state.items.filter(function(a){ return a.status==='archived'; }).sort(function(a,b){ return new Date(b.datetime)-new Date(a.datetime); });
  if(!arr.length){ arch.innerHTML='<p class=\"muted small\">Archiv ist leer.</p>'; return; }
  arr.forEach(function(a){
    var it=el('div',{class:'item'});
    var person = Array.isArray(a.person)?a.person.join(', '):(a.person||'—');
    it.append(el('div',{class:'title'}, a.title||'(ohne Titel)'));
    it.append(el('div',{}, a.category+' • '+fmt(a.datetime)+' ✓'));
    it.append(el('div',{}, 'Person(en): '+person));
    it.append(el('div',{}, 'Standort: '+(a.location||'—')));
    it.append(el('div',{}, 'Notizen: '+(a.notes||'—')));
    var row=el('div',{class:'btnrow'});
    var btnBack=el('button',{}, '↩︎ Zurückholen');
    btnBack.addEventListener('click', function(){ a.status='upcoming'; save(); renderArchive(); });
    row.append(btnBack);
    it.append(row);
    arch.append(it);
  });
}

function exportCSV(){
  var rows=[['Titel','Kategorie','Datum','Uhrzeit','Person(en)','Standort','Notizen','Status']];
  var all=state.items.slice().sort(function(a,b){ return new Date(a.datetime)-new Date(b.datetime); });
  all.forEach(function(a){
    var d=new Date(a.datetime);
    var date=d.toLocaleDateString('de-CH');
    var time=d.toLocaleTimeString('de-CH',{hour:'2-digit',minute:'2-digit'});
    var person = Array.isArray(a.person)?a.person.join('; '):(a.person||'');
    rows.push([a.title||'', a.category, date, time, person, a.location||'', String(a.notes||'').replace(/\\n/g,' '), a.status]);
  });
  var csv=rows.map(function(r){ return r.map(function(x){ return '\"'+String(x).replace(/\"/g,'\"\"')+'\"'; }).join(';'); }).join('\\r\\n');
  var blob=new Blob([csv], {type:'text/csv;charset=utf-8'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a'); a.href=url; a.download='TimeMateJW_Export.csv'; a.click(); URL.revokeObjectURL(url);
}

function exportPrint(){
  var all=state.items.slice().sort(function(a,b){ return new Date(a.datetime)-new Date(b.datetime); });
  var rows=all.map(function(a){
    var d=fmt(a.datetime); var p = Array.isArray(a.person)?a.person.join(', '):(a.person||'—');
    return '<tr>'
      + '<td>'+String(a.title||'—').replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[m]; })+'</td>'
      + '<td>'+a.category+'</td>'
      + '<td>'+d+'</td>'
      + '<td>'+String(p).replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[m]; })+'</td>'
      + '<td>'+String(a.location||'—').replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[m]; })+'</td>'
      + '<td>'+String(a.notes||'—').replace(/[&<>\"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[m]; })+'</td>'
      + '<td>'+a.status+'</td>'
      + '</tr>';
  }).join('');
  var html='<!doctype html><html><head><meta charset=\"utf-8\"><title>TimeMate JW Export</title>'
    + '<style>body{font-family:-apple-system,Segoe UI,Roboto,Arial;padding:24px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:6px 8px}th{background:#f3f4f6}</style>'
    + '</head><body onload=\"setTimeout(function(){window.print()},300)\">'
    + '<h1>TimeMate JW – Export</h1>'
    + '<table><thead><tr><th>Titel</th><th>Kategorie</th><th>Datum & Uhrzeit</th><th>Person(en)</th><th>Standort</th><th>Notizen</th><th>Status</th></tr></thead>'
    + '<tbody>'+rows+'</tbody></table>'
    + '</body></html>';
  var w=window.open('', '_blank'); w.document.write(html); w.document.close();
}

function renderSettings(){
  var v=byId('view'); v.innerHTML = '<section><h2>Einstellungen</h2><div class=\"btnrow\"><button id=\"exp-csv\">Als Excel/CSV exportieren</button><button id=\"exp-pdf\">Als PDF exportieren (Druckansicht)</button><button id=\"wipe\" class=\"danger\">Alle Termine löschen</button></div></section>';
  byId('exp-csv').addEventListener('click', exportCSV);
  byId('exp-pdf').addEventListener('click', exportPrint);
  byId('wipe').addEventListener('click', function(){ if(confirm('Wirklich alles löschen?')){ state.items=[]; save(); alert('Gelöscht.'); route('overview'); }});
}

document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('nav .tab').forEach(function(b){ b.addEventListener('click', function(){ route(b.dataset.route); }); });
  var r=(location.hash||'#overview').replace('#','');
  route(r);
  if(!byId('view').hasChildNodes()){ route('overview'); }
});
</script>

<datalist id="locs">
  <option>5000 Aarau</option><option>5200 Brugg</option><option>5400 Baden</option><option>5405 Dättwil</option><option>5442 Fislisbach</option>
</datalist>
<datalist id="persons">
  <option>Aleks</option><option>Alina</option><option>Mama</option><option>Papa</option><option>Luana</option><option>Yulio</option>
</datalist>

</body>
</html>
